(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1)+e);window.helpers={getRandomArrayElement:t=>t[e(0,t.length-1)],getRandomValueFromRange:e,takeRandomNumberOfArrayElements:t=>{const n=e(0,t.length-1);return(t=>{const n=t.slice();for(let t=n.length-1;t>0;t-=1){const o=e(0,t),r=n[t];n[t]=n[o],n[o]=r}return n})(t).slice(0,n)}}})(),window.load={loadData:(e,t,n)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?t(o.response):n(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e4,o.open("GET",e),o.send()}},window.upload={uploadForm:(e,t,n)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?t(o.response):n(`Статус ответа: ${o.status} ${o.statusText}`)})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t={rooms:{singular:"комната",nominative:"комнаты",genitive:"комнат"},guests:{singular:"гостя",plural:"гостей"}},n=(e,t)=>{const n=document.createElement("li");return n.classList.add("popup__feature"),n.classList.add("popup__feature--"+e.offer.features[t]),n},o=(e,t)=>{const n=document.createElement("img");return n.src=e.offer.photos[t],n.classList.add("popup__photo"),n.width=45,n.height=40,n.alt="Фотография жилья",n};window.card={createCard:(r,i)=>{const s=r.cloneNode(!0),a=s.querySelector(".popup__title"),u=s.querySelector(".popup__text--address"),d=s.querySelector(".popup__text--price"),l=s.querySelector(".popup__type"),c=s.querySelector(".popup__text--capacity"),p=s.querySelector(".popup__text--time"),m=s.querySelector(".popup__features"),f=s.querySelector(".popup__description"),v=s.querySelector(".popup__photos"),y=s.querySelector(".popup__avatar"),g=i.offer.type;a.textContent=i.offer.title,u.textContent=i.offer.address,d.textContent=i.offer.price+"₽/ночь",l.textContent=e[g];const h=((e,t)=>{const n=Math.abs(e)%100,o=e%10;return n>10&&n<20?t.rooms.genitive:o>1&&o<5?t.rooms.nominative:1===o?t.rooms.singular:t.rooms.genitive})(i.offer.rooms,t),w=(I=i.offer.guests,b=t,1==Math.abs(I)%10?b.guests.singular:b.guests.plural);var I,b;c.textContent=`${i.offer.rooms} ${h} для ${i.offer.guests} ${w}`,p.textContent=`Заезд после ${i.offer.checkin}, выезд до ${i.offer.checkout}`,m.innerHTML="";for(let e=0;e<i.offer.features.length;e+=1){const t=n(i,e);m.appendChild(t)}f.textContent=i.offer.description,v.innerHTML="";for(let e=0;e<i.offer.photos.length;e+=1){const t=o(i,e);v.appendChild(t)}return y.setAttribute("src",i.author.avatar),s}}})(),window.form={getValidityCheckHandlers:e=>{const t="Выбранное количество гостей не подходит под количество комнат";return{checkGuestNumberValidity:()=>{"1"===e.roomsInput.value&&"1"!==e.guestsInput.value?(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity()):"2"!==e.roomsInput.value||"3"!==e.guestsInput.value&&"0"!==e.guestsInput.value?"3"===e.roomsInput.value&&"0"===e.guestsInput.value||"100"===e.roomsInput.value&&"0"!==e.guestsInput.value?(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity()):(e.guestsInput.setCustomValidity(""),e.guestsInput.reportValidity()):(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity())},validateTitle:()=>{e.titleInput.required=!0,e.titleInput.setAttribute("minlength",30),e.titleInput.setAttribute("maxlength",100)},validateHousingType:()=>{switch(e.housingTypeInput.value){case"bungalow":e.priceInput.setAttribute("min",0),e.priceInput.setAttribute("placeholder",0);break;case"flat":e.priceInput.setAttribute("min",1e3),e.priceInput.setAttribute("placeholder",1e3);break;case"house":e.priceInput.setAttribute("min",5e3),e.priceInput.setAttribute("placeholder",5e3);break;case"palace":e.priceInput.setAttribute("min",1e4),e.priceInput.setAttribute("placeholder",1e4)}},validatePrice:()=>{e.priceInput.required=!0,e.priceInput.setAttribute("max",1e6)},validateCheckIn:()=>{e.checkOutInput.value=e.checkInInput.value},validateCheckOut:()=>{e.checkInInput.value=e.checkOutInput.value},validateImage:e=>{e.setAttribute("accept","image/*")}}}},window.activation={getPageActivationHandlers:(e,t,n,o,r)=>{const i=e.mainPin.offsetWidth,s=e.mainPin.offsetHeight,a=s+22,u=e.mainPin.offsetLeft+i/2,d=e.mainPin.offsetTop+s/2,l=e.mainPin.offsetTop+a,c=(t,n)=>{e.addressInput.setAttribute("value",`${Math.round(t)}, ${Math.round(n)}`)},p=e=>{0===e.button&&f()},m=e=>{"Enter"===e.key&&f()},f=()=>{e.map.classList.remove("map--faded"),e.form.classList.remove("ad-form--disabled");for(let t=0;t<e.formFieldsets.length;t+=1)e.formFieldsets[t].removeAttribute("disabled");c(u,l),window.load.loadData(n,o,r),e.mainPin.removeEventListener("mousedown",p),e.mainPin.removeEventListener("keydown",m)};return{setInactivePageMode:()=>{e.map.classList.contains("map--faded")||e.map.classList.add("map--faded"),e.form.classList.add("ad-form--disabled"),t.clearPins();for(let t=0;t<e.formFieldsets.length;t+=1)e.formFieldsets[t].setAttribute("disabled","");for(let t=0;t<e.filtersFieldsets.length;t+=1)e.filtersFieldsets[t].setAttribute("disabled","");c(u,d),e.mainPin.addEventListener("mousedown",p),e.mainPin.addEventListener("keydown",m)},pinWidth:i,pinHeight:s,pinHeightActive:a}},activateFilters:e=>{for(let t=0;t<e.filtersFieldsets.length;t+=1)e.filtersFieldsets[t].removeAttribute("disabled")}},window.pin={createPin:(e,t)=>{const n=e.cloneNode(!0),o=n.querySelector("img");return n.setAttribute("style",`left: ${t.location.x+window.main.pageActivation.pinWidth/2}px; top: ${t.location.y+window.main.pageActivation.pinHeight}px;`),o.setAttribute("src",""+t.author.avatar),o.setAttribute("alt",""+t.offer.title),n}},window.map={getRenderingHandlers:(e,t)=>{const n=t=>{const n=window.card.createCard(e.cardTemplate,t);n.querySelector(".popup__close").addEventListener("click",(e=>{0===e.button&&n.classList.add("hidden")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&n.classList.add("hidden")})),e.map.insertBefore(n,e.mapFilters),e.filtersFieldsets.forEach((e=>{e.addEventListener("input",(()=>{n.classList.add("hidden")}))}))};return{renderPins:o=>{const r=document.createDocumentFragment(),i=o.length>5?5:o.length;for(let s=0;s<i;s+=1){const i=window.pin.createPin(e.pinTemplate,o[s]),a=e=>{0===e.button&&(t.clearCards(),n(o[s]))};i.addEventListener("click",a),r.appendChild(i)}e.pinsList.appendChild(r)},renderCards:n}}},window.pinMovement={getPinMovementHandlers:(e,t)=>{let n={left:null,top:null};const o=t.pinWidth,r=t.pinHeight,i=e.map.offsetWidth;let s={x:null,y:null};const a=t=>{var a;t.preventDefault(),((e,t)=>{t.style.left=Math.max(0-o/2,Math.min(e.clientX-n.left,i-o/2))+"px",t.style.top=Math.max(130-r,Math.min(e.clientY-n.top,630-r))+"px"})(t,e.mainPin),a=e.mainPin,s.x=a.offsetLeft+o/2,s.y=a.offsetTop+r,e.addressInput.value=`${s.x}, ${s.y}`},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u)};return{onMainPinClick:t=>{t.preventDefault(),0===t.button&&(n.left=t.clientX-e.mainPin.offsetLeft,n.top=t.clientY-e.mainPin.offsetTop,document.addEventListener("mousemove",a),document.addEventListener("mouseup",u))}}}},(()=>{const e=document.querySelector("#capacity"),t=document.querySelector("#room_number"),n=document.querySelector(".map__filters-container"),o=document.querySelector(".map"),r=document.querySelector("#card").content.querySelector(".map__card"),i=document.querySelector("#success").content.querySelector(".success"),s=document.querySelector("#error").content.querySelector(".error"),a=document.querySelector(".ad-form__reset"),u=document.querySelector("#pin").content.querySelector(".map__pin"),d=document.querySelector(".map__pins"),l=document.querySelector("#housing-type"),c=document.querySelector(".map__pin--main"),p=document.querySelector(".ad-form"),m=p.querySelectorAll("fieldset"),f=document.querySelector(".map__filters").querySelectorAll("select, input"),v=document.querySelector("#address"),y=document.querySelector("#title"),g=document.querySelector("#type"),h=document.querySelector("#price"),w=document.querySelector("#timein"),I=document.querySelector("#timeout"),b=document.querySelector("#avatar"),L=document.querySelector("#images"),q={mainPin:c,map:o,form:p,formFieldsets:m,filtersFieldsets:f,addressInput:v,pinTemplate:u,pinsList:d,cardTemplate:r,mapFilters:n,guestsInput:e,roomsInput:t,titleInput:y,housingTypeInput:g,priceInput:h,checkInInput:w,checkOutInput:I};let _=[];const k=()=>{const e=d.querySelectorAll(".map__pin");for(let t=1;t<e.length;t+=1)e[t].remove()},S={clearPins:k,clearCards:()=>{document.querySelectorAll(".map .map__card").forEach((e=>{e.remove()}))}},{renderPins:E}=window.map.getRenderingHandlers(q,S),P=()=>{if(k(),"any"!==l.value){const e=_.filter((e=>e.offer.type===l.value));E(e)}else E(_)},C=e=>({onPopupEscPress:t=>{"Escape"===t.key&&e.remove()},onPopupClick:t=>{0===t.button&&e.remove()}}),A=()=>{p.reset(),M.setInactivePageMode();const e=i.cloneNode(!0);document.querySelector("main").appendChild(e),document.addEventListener("keydown",C(e).onPopupEscPress),document.addEventListener("click",C(e).onPopupClick)},x=()=>{const e=s.cloneNode(!0);document.querySelector("main").appendChild(e);const t=document.querySelector(".error__button");document.addEventListener("keydown",C(e).onPopupEscPress),document.addEventListener("click",C(e).onPopupClick),t.addEventListener("click",C(e).onPopupClick)},M=window.activation.getPageActivationHandlers(q,S,"https://21.javascript.pages.academy/keksobooking/data",(e=>{_=e,P(),window.activation.activateFilters(q)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),T={pinWidth:M.pinWidth,pinHeight:M.pinHeightActive},H=window.pinMovement.getPinMovementHandlers(q,T).onMainPinClick;c.addEventListener("mousedown",H);const{checkGuestNumberValidity:F,validateTitle:$,validateHousingType:V,validatePrice:D,validateCheckIn:O,validateCheckOut:R,validateImage:N}=window.form.getValidityCheckHandlers(q);document.addEventListener("DOMContentLoaded",(()=>{F()})),l.addEventListener("input",(()=>{P()})),e.addEventListener("input",(()=>{F()})),t.addEventListener("input",(()=>{F()})),g.addEventListener("input",(()=>{V()})),w.addEventListener("input",(()=>{O()})),I.addEventListener("input",(()=>{R()})),$(),D(),N(b),N(L),M.setInactivePageMode(),p.addEventListener("submit",(e=>{window.upload.uploadForm(new FormData(p),A,x),e.preventDefault()})),a.addEventListener("click",(e=>{0===e.button&&(e.preventDefault(),p.reset())})),window.main={pageActivation:M}})()})();