(()=>{"use strict";window.debounce=function(e){let t=null;return()=>{t&&window.clearTimeout(t),t=window.setTimeout(e,500)}},window.filter={getFilterHandlers:e=>{const t=Array.from(e.featuresInputs);return n=>{const r=[];for(let i=0;i<n.length;i+=1){const s=n[i],a=e=>{switch(e.value){case"any":return!0;case"low":return s.offer.price<=1e4;case"middle":return s.offer.price>1e4&&s.offer.price<=5e4;case"high":return s.offer.price>=5e4;default:return!1}},u=e=>"any"===e.value||s.offer.rooms===Number(e.value),c=e=>"any"===e.value||s.offer.guests===Number(e.value),d=e=>e.every((e=>!e.checked||e.checked&&s.offer.features.includes(e.value)));if(("any"===(o=e.housingTypeFilter).value||s.offer.type===o.value)&&a(e.priceFilter)&&u(e.roomsNumberFilter)&&c(e.guestsNumberFilter)&&d(t)&&r.push(s),5===r.length)break}var o;return r}}},window.load={loadData:(e,t,n)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?t(r.response):n(`Статус ответа: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.timeout=1e4,r.open("GET",e),r.send()}},(()=>{const e=["gif","jpg","jpeg","png"];window.imagePreview={getImagePreview:(t,n)=>{t.addEventListener("change",(()=>{const r=t.files[0],o=r.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n.src=e.result})),e.readAsDataURL(r)}}))}}})(),window.upload={uploadForm:(e,t,n)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?t(r.response):n(`Статус ответа: ${r.status} ${r.statusText}`)})),r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(e)}},(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t={rooms:{singular:"комната",nominative:"комнаты",genitive:"комнат"},guests:{singular:"гостя",plural:"гостей"}},n=(e,t)=>{const n=document.createElement("img");return n.src=e.offer.photos[t],n.classList.add("popup__photo"),n.width=45,n.height=40,n.alt="Фотография жилья",n};window.card={createCard:(r,o)=>{const i=r.cloneNode(!0),s=i.querySelector(".popup__title"),a=i.querySelector(".popup__text--address"),u=i.querySelector(".popup__text--price"),c=i.querySelector(".popup__type"),d=i.querySelector(".popup__text--capacity"),l=i.querySelector(".popup__text--time"),p=i.querySelector(".popup__features"),m=i.querySelector(".popup__description"),f=i.querySelector(".popup__photos"),v=i.querySelector(".popup__avatar"),y=o.offer.type;s.textContent=o.offer.title,a.textContent=o.offer.address,u.textContent=o.offer.price+"₽/ночь",c.textContent=e[y];const g=((e,t)=>{const n=Math.abs(e)%100,r=e%10;return n>10&&n<20?t.rooms.genitive:r>1&&r<5?t.rooms.nominative:1===r?t.rooms.singular:t.rooms.genitive})(o.offer.rooms,t),h=(w=o.offer.guests,L=t,1==Math.abs(w)%10?L.guests.singular:L.guests.plural);var w,L;d.textContent=`${o.offer.rooms} ${g} для ${o.offer.guests} ${h}`,l.textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`,p.innerHTML="",o.offer.features.forEach(((e,t)=>{const n=((e,t)=>{const n=document.createElement("li");return n.classList.add("popup__feature"),n.classList.add("popup__feature--"+e.offer.features[t]),n})(o,t);p.appendChild(n)})),m.textContent=o.offer.description,f.innerHTML="";for(let e=0;e<o.offer.photos.length;e+=1){const t=n(o,e);f.appendChild(t)}return v.setAttribute("src",o.author.avatar),i}}})(),window.form={getValidityCheckHandlers:e=>{const t="Выбранное количество гостей не подходит под количество комнат";return{validateGuestsNumber:()=>{"1"===e.roomsInput.value&&"1"!==e.guestsInput.value?(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity()):"2"!==e.roomsInput.value||"3"!==e.guestsInput.value&&"0"!==e.guestsInput.value?"3"===e.roomsInput.value&&"0"===e.guestsInput.value||"100"===e.roomsInput.value&&"0"!==e.guestsInput.value?(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity()):(e.guestsInput.setCustomValidity(""),e.guestsInput.reportValidity()):(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity())},setTitleConstraints:()=>{e.titleInput.required=!0,e.titleInput.setAttribute("minlength",30),e.titleInput.setAttribute("maxlength",100)},setHousingTypeConstraints:()=>{switch(e.housingTypeInput.value){case"bungalow":e.priceInput.setAttribute("min",0),e.priceInput.setAttribute("placeholder",0);break;case"flat":e.priceInput.setAttribute("min",1e3),e.priceInput.setAttribute("placeholder",1e3);break;case"house":e.priceInput.setAttribute("min",5e3),e.priceInput.setAttribute("placeholder",5e3);break;case"palace":e.priceInput.setAttribute("min",1e4),e.priceInput.setAttribute("placeholder",1e4)}},setPriceConstraints:()=>{e.priceInput.required=!0,e.priceInput.setAttribute("max",1e6)},setCheckInConstraints:()=>{e.checkOutInput.value=e.checkInInput.value},setCheckOutConstraints:()=>{e.checkInInput.value=e.checkOutInput.value},setImageConstraints:e=>{e.setAttribute("accept","image/*")}}}},window.activation={getPageActivationHandlers:(e,t,n,r,o)=>{const i=e.mainPin.offsetWidth,s=e.mainPin.offsetHeight,a=s+22,u=e.mainPin.offsetLeft+i/2,c=e.mainPin.offsetTop+s/2,d=e.mainPin.offsetTop+a,l=e.mainPin.offsetLeft,p=e.mainPin.offsetTop,m=(t,n)=>{e.addressInput.setAttribute("value",`${Math.round(t)}, ${Math.round(n)}`)},f=()=>{e.map.classList.remove("map--faded"),e.form.classList.remove("ad-form--disabled"),e.formFieldsets.forEach((e=>{e.removeAttribute("disabled")})),m(u,d),window.load.loadData(n,r,o),e.mainPin.removeEventListener("mousedown",v),e.mainPin.removeEventListener("keydown",y)},v=e=>{0===e.button&&f()},y=e=>{"Enter"===e.key&&f()};return{setInactivePageMode:()=>{e.map.classList.contains("map--faded")||e.map.classList.add("map--faded"),e.form.classList.add("ad-form--disabled"),t.clearPins(),t.clearCards(),e.formFieldsets.forEach((e=>{e.setAttribute("disabled","")})),e.filtersFieldsets.forEach((e=>{e.setAttribute("disabled","")})),e.mainPin.style.left=l+"px",e.mainPin.style.top=p+"px",m(u,c),e.mainPin.addEventListener("mousedown",v),e.mainPin.addEventListener("keydown",y)},pinWidth:i,pinHeight:s,pinHeightActive:a}},activateFilters:e=>{e.filtersFieldsets.forEach((e=>{e.removeAttribute("disabled")}))}},window.pin={createPin:(e,t)=>{const n=e.cloneNode(!0),r=n.querySelector("img");return n.setAttribute("style",`left: ${t.location.x+window.main.pageActivation.pinWidth/2}px; top: ${t.location.y+window.main.pageActivation.pinHeight}px;`),r.setAttribute("src",""+t.author.avatar),r.setAttribute("alt",""+t.offer.title),n}},window.map={getRenderingHandlers:(e,t)=>{const n=t=>{const n=window.card.createCard(e.cardTemplate,t),r=n.querySelector(".popup__close"),o=e=>{"Escape"===e.key&&(n.classList.add("hidden"),document.removeEventListener("keydown",o))};r.addEventListener("click",(e=>{0===e.button&&(n.classList.add("hidden"),document.removeEventListener("keydown",o))})),document.addEventListener("keydown",o),e.map.insertBefore(n,e.mapFilters),e.filtersFieldsets.forEach((e=>{e.addEventListener("input",(()=>{n.classList.add("hidden")}))}))};return{renderPins:r=>{const o=document.createDocumentFragment();for(let i=0;i<Math.min(r.length,5);i+=1){const s=window.pin.createPin(e.pinTemplate,r[i]),a=e=>{0===e.button&&(t.clearCards(),n(r[i]),s.classList.add("map__pin--active"))};s.addEventListener("click",a),o.appendChild(s)}e.pinsList.appendChild(o)},renderCards:n}}},window.pinMovement={getPinMovementHandlers:(e,t)=>{let n={left:null,top:null};const r=t.pinWidth,o=t.pinHeight,i=e.map.offsetWidth;let s={x:null,y:null};const a=t=>{var a;t.preventDefault(),((e,t)=>{t.style.left=Math.max(0-r/2,Math.min(e.clientX-n.left,i-r/2))+"px",t.style.top=Math.max(130-o,Math.min(e.clientY-n.top,630-o))+"px"})(t,e.mainPin),a=e.mainPin,s.x=Math.round(a.offsetLeft+r/2),s.y=Math.round(a.offsetTop+o),e.addressInput.value=`${s.x}, ${s.y}`},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u)};return{onMainPinClick:t=>{t.preventDefault(),0===t.button&&(n.left=t.clientX-e.mainPin.offsetLeft,n.top=t.clientY-e.mainPin.offsetTop,document.addEventListener("mousemove",a),document.addEventListener("mouseup",u))}}}},(()=>{const e=document.querySelector("#capacity"),t=document.querySelector("#room_number"),n=document.querySelector(".map__filters-container"),r=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card"),i=document.querySelector("#success").content.querySelector(".success"),s=document.querySelector("#error").content.querySelector(".error"),a=document.querySelector(".ad-form__reset"),u=document.querySelector(".ad-form__submit"),c=document.querySelector("#pin").content.querySelector(".map__pin"),d=document.querySelector(".map__pins"),l=document.querySelector("#housing-type"),p=document.querySelector("#housing-price"),m=document.querySelector("#housing-rooms"),f=document.querySelector("#housing-guests"),v=document.querySelector("#housing-features").querySelectorAll("input"),y=document.querySelector(".map__pin--main"),g=document.querySelector(".ad-form"),h=g.querySelectorAll("fieldset"),w=document.querySelector(".map__filters"),L=w.querySelectorAll("select, input"),E=document.querySelector("#address"),b=document.querySelector("#title"),I=document.querySelector("#type"),_=document.querySelector("#price"),P=document.querySelector("#timein"),k=document.querySelector("#timeout"),q=document.querySelector("#avatar"),S=document.querySelector("#images"),C=document.querySelector(".ad-form-header__preview img"),x=document.querySelector(".ad-form__photo"),A={mainPin:y,map:r,form:g,formFieldsets:h,filtersFieldsets:L,addressInput:E,pinTemplate:c,pinsList:d,cardTemplate:o,mapFilters:n,guestsInput:e,roomsInput:t,titleInput:b,housingTypeInput:I,priceInput:_,checkInInput:P,checkOutInput:k,housingTypeFilter:l,priceFilter:p,roomsNumberFilter:m,guestsNumberFilter:f,featuresInputs:v},T=[b,_,e];let F=[];const M=()=>{const e=d.querySelectorAll(".map__pin");for(let t=1;t<e.length;t+=1)e[t].remove()},H={clearPins:M,clearCards:()=>{document.querySelectorAll(".map .map__card").forEach((e=>{e.remove()})),d.querySelectorAll(".map__pin").forEach((e=>{e.classList.remove("map__pin--active")}))}},{renderPins:$}=window.map.getRenderingHandlers(A,H),N=window.filter.getFilterHandlers(A),V=()=>{M();const e=N(F);$(e)},D=e=>({onPopupEscPress:t=>{"Escape"===t.key&&(e.remove(),document.removeEventListener("keydown",D(e).onPopupEscPress),document.removeEventListener("click",D(e).onPopupClick))},onPopupClick:t=>{0===t.button&&(e.remove(),document.removeEventListener("click",D(e).onPopupClick),document.removeEventListener("keydown",D(e).onPopupEscPress))}}),W=()=>{g.reset(),w.reset(),O.setInactivePageMode();const e=i.cloneNode(!0);document.querySelector("main").appendChild(e),document.addEventListener("keydown",D(e).onPopupEscPress),document.addEventListener("click",D(e).onPopupClick)},j=()=>{const e=s.cloneNode(!0);document.querySelector("main").appendChild(e);const t=document.querySelector(".error__button");document.addEventListener("keydown",D(e).onPopupEscPress),document.addEventListener("click",D(e).onPopupClick),t.addEventListener("click",D(e).onPopupClick)},O=window.activation.getPageActivationHandlers(A,H,"https://21.javascript.pages.academy/keksobooking/data",(e=>{F=e,V(),window.activation.activateFilters(A)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),R={pinWidth:O.pinWidth,pinHeight:O.pinHeightActive},X=window.pinMovement.getPinMovementHandlers(A,R).onMainPinClick;y.addEventListener("mousedown",X);const{validateGuestsNumber:G,setTitleConstraints:z,setHousingTypeConstraints:Y,setPriceConstraints:B,setCheckInConstraints:U,setCheckOutConstraints:J,setImageConstraints:K}=window.form.getValidityCheckHandlers(A);document.addEventListener("DOMContentLoaded",G),l.addEventListener("input",V),w.addEventListener("input",window.debounce(V)),e.addEventListener("input",G),t.addEventListener("input",G),I.addEventListener("input",Y),P.addEventListener("input",U),k.addEventListener("input",J),z(),B(),K(q),K(S),window.imagePreview.getImagePreview(q,C);const Q=document.createElement("img");Q.alt="Фотография жилья",Q.style.width="100%",S.addEventListener("change",(()=>{x.appendChild(Q)})),window.imagePreview.getImagePreview(S,Q),O.setInactivePageMode(),g.addEventListener("submit",(e=>{window.upload.uploadForm(new FormData(g),W,j),e.preventDefault()})),u.addEventListener("click",(()=>{T.forEach((e=>{e.style=e.checkValidity()?"":"box-shadow: 0 0 2px 2px red;"}))})),T.forEach((e=>{e.addEventListener("input",(()=>{e.style=e.checkValidity()?"":"box-shadow: 0 0 2px 2px red"}))})),a.addEventListener("click",(e=>{0===e.button&&(e.preventDefault(),g.reset(),w.reset(),O.setInactivePageMode())})),window.main={pageActivation:O}})()})();