(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1)+e);window.helpers={getRandomArrayElement:t=>t[e(0,t.length-1)],getRandomValueFromRange:e,takeRandomNumberOfArrayElements:t=>{const n=e(0,t.length-1);return(t=>{const n=t.slice();for(let t=n.length-1;t>0;t-=1){const r=e(0,t),o=n[t];n[t]=n[r],n[r]=o}return n})(t).slice(0,n)}}})(),window.debounce=function(e){let t=null;return()=>{t&&window.clearTimeout(t),t=window.setTimeout(e,500)}},window.filter={getFilterHandlers:e=>{const t=Array.from(e.featuresInputs);return n=>{const r=[];for(let i=0;i<n.length;i+=1){const s=n[i],a=e=>{switch(e.value){case"any":return!0;case"low":return s.offer.price<=1e4;case"middle":return s.offer.price>1e4&&s.offer.price<=5e4;case"high":return s.offer.price>=5e4;default:return!1}},u=e=>"any"===e.value||s.offer.rooms===Number(e.value),d=e=>"any"===e.value||s.offer.guests===Number(e.value),c=e=>e.every((e=>!e.checked||e.checked&&s.offer.features.includes(e.value)));if(("any"===(o=e.housingTypeFilter).value||s.offer.type===o.value)&&a(e.priceFilter)&&u(e.roomsNumberFilter)&&d(e.guestsNumberFilter)&&c(t)&&r.push(s),5===r.length)break}var o;return r}}},window.load={loadData:(e,t,n)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?t(r.response):n(`Статус ответа: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.timeout=1e4,r.open("GET",e),r.send()}},(()=>{const e=["gif","jpg","jpeg","png"];window.imagePreview={getImagePreview:(t,n)=>{t.addEventListener("change",(()=>{const r=t.files[0],o=r.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n.src=e.result})),e.readAsDataURL(r)}}))}}})(),window.upload={uploadForm:(e,t,n)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?t(r.response):n(`Статус ответа: ${r.status} ${r.statusText}`)})),r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(e)}},(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t={rooms:{singular:"комната",nominative:"комнаты",genitive:"комнат"},guests:{singular:"гостя",plural:"гостей"}},n=(e,t)=>{const n=document.createElement("li");return n.classList.add("popup__feature"),n.classList.add("popup__feature--"+e.offer.features[t]),n},r=(e,t)=>{const n=document.createElement("img");return n.src=e.offer.photos[t],n.classList.add("popup__photo"),n.width=45,n.height=40,n.alt="Фотография жилья",n};window.card={createCard:(o,i)=>{const s=o.cloneNode(!0),a=s.querySelector(".popup__title"),u=s.querySelector(".popup__text--address"),d=s.querySelector(".popup__text--price"),c=s.querySelector(".popup__type"),l=s.querySelector(".popup__text--capacity"),p=s.querySelector(".popup__text--time"),m=s.querySelector(".popup__features"),f=s.querySelector(".popup__description"),v=s.querySelector(".popup__photos"),g=s.querySelector(".popup__avatar"),y=i.offer.type;a.textContent=i.offer.title,u.textContent=i.offer.address,d.textContent=i.offer.price+"₽/ночь",c.textContent=e[y];const h=((e,t)=>{const n=Math.abs(e)%100,r=e%10;return n>10&&n<20?t.rooms.genitive:r>1&&r<5?t.rooms.nominative:1===r?t.rooms.singular:t.rooms.genitive})(i.offer.rooms,t),w=(L=i.offer.guests,b=t,1==Math.abs(L)%10?b.guests.singular:b.guests.plural);var L,b;l.textContent=`${i.offer.rooms} ${h} для ${i.offer.guests} ${w}`,p.textContent=`Заезд после ${i.offer.checkin}, выезд до ${i.offer.checkout}`,m.innerHTML="";for(let e=0;e<i.offer.features.length;e+=1){const t=n(i,e);m.appendChild(t)}f.textContent=i.offer.description,v.innerHTML="";for(let e=0;e<i.offer.photos.length;e+=1){const t=r(i,e);v.appendChild(t)}return g.setAttribute("src",i.author.avatar),s}}})(),window.form={getValidityCheckHandlers:e=>{const t="Выбранное количество гостей не подходит под количество комнат";return{checkGuestNumberValidity:()=>{"1"===e.roomsInput.value&&"1"!==e.guestsInput.value?(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity()):"2"!==e.roomsInput.value||"3"!==e.guestsInput.value&&"0"!==e.guestsInput.value?"3"===e.roomsInput.value&&"0"===e.guestsInput.value||"100"===e.roomsInput.value&&"0"!==e.guestsInput.value?(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity()):(e.guestsInput.setCustomValidity(""),e.guestsInput.reportValidity()):(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity())},validateTitle:()=>{e.titleInput.required=!0,e.titleInput.setAttribute("minlength",30),e.titleInput.setAttribute("maxlength",100)},validateHousingType:()=>{switch(e.housingTypeInput.value){case"bungalow":e.priceInput.setAttribute("min",0),e.priceInput.setAttribute("placeholder",0);break;case"flat":e.priceInput.setAttribute("min",1e3),e.priceInput.setAttribute("placeholder",1e3);break;case"house":e.priceInput.setAttribute("min",5e3),e.priceInput.setAttribute("placeholder",5e3);break;case"palace":e.priceInput.setAttribute("min",1e4),e.priceInput.setAttribute("placeholder",1e4)}},validatePrice:()=>{e.priceInput.required=!0,e.priceInput.setAttribute("max",1e6)},validateCheckIn:()=>{e.checkOutInput.value=e.checkInInput.value},validateCheckOut:()=>{e.checkInInput.value=e.checkOutInput.value},validateImage:e=>{e.setAttribute("accept","image/*")}}}},window.activation={getPageActivationHandlers:(e,t,n,r,o)=>{const i=e.mainPin.offsetWidth,s=e.mainPin.offsetHeight,a=s+22,u=e.mainPin.offsetLeft+i/2,d=e.mainPin.offsetTop+s/2,c=e.mainPin.offsetTop+a,l=e.mainPin.offsetLeft,p=e.mainPin.offsetTop,m=(t,n)=>{e.addressInput.setAttribute("value",`${Math.round(t)}, ${Math.round(n)}`)},f=e=>{0===e.button&&g()},v=e=>{"Enter"===e.key&&g()},g=()=>{e.map.classList.remove("map--faded"),e.form.classList.remove("ad-form--disabled");for(let t=0;t<e.formFieldsets.length;t+=1)e.formFieldsets[t].removeAttribute("disabled");m(u,c),window.load.loadData(n,r,o),e.mainPin.removeEventListener("mousedown",f),e.mainPin.removeEventListener("keydown",v)};return{setInactivePageMode:()=>{e.map.classList.contains("map--faded")||e.map.classList.add("map--faded"),e.form.classList.add("ad-form--disabled"),t.clearPins(),t.clearCards();for(let t=0;t<e.formFieldsets.length;t+=1)e.formFieldsets[t].setAttribute("disabled","");for(let t=0;t<e.filtersFieldsets.length;t+=1)e.filtersFieldsets[t].setAttribute("disabled","");e.mainPin.style.left=l+"px",e.mainPin.style.top=p+"px",m(u,d),e.mainPin.addEventListener("mousedown",f),e.mainPin.addEventListener("keydown",v)},pinWidth:i,pinHeight:s,pinHeightActive:a}},activateFilters:e=>{for(let t=0;t<e.filtersFieldsets.length;t+=1)e.filtersFieldsets[t].removeAttribute("disabled")}},window.pin={createPin:(e,t)=>{const n=e.cloneNode(!0),r=n.querySelector("img");return n.setAttribute("style",`left: ${t.location.x+window.main.pageActivation.pinWidth/2}px; top: ${t.location.y+window.main.pageActivation.pinHeight}px;`),r.setAttribute("src",""+t.author.avatar),r.setAttribute("alt",""+t.offer.title),n}},window.map={getRenderingHandlers:(e,t)=>{const n=t=>{const n=window.card.createCard(e.cardTemplate,t),r=n.querySelector(".popup__close"),o=e=>{"Escape"===e.key&&(n.classList.add("hidden"),document.removeEventListener("keydown",o))};r.addEventListener("click",(e=>{0===e.button&&(n.classList.add("hidden"),document.removeEventListener("keydown",o))})),document.addEventListener("keydown",o),e.map.insertBefore(n,e.mapFilters),e.filtersFieldsets.forEach((e=>{e.addEventListener("input",(()=>{n.classList.add("hidden")}))}))};return{renderPins:r=>{const o=document.createDocumentFragment();for(let i=0;i<Math.min(r.length,5);i+=1){const s=window.pin.createPin(e.pinTemplate,r[i]),a=e=>{0===e.button&&(t.clearCards(),n(r[i]),s.classList.add("map__pin--active"))};s.addEventListener("click",a),o.appendChild(s)}e.pinsList.appendChild(o)},renderCards:n}}},window.pinMovement={getPinMovementHandlers:(e,t)=>{let n={left:null,top:null};const r=t.pinWidth,o=t.pinHeight,i=e.map.offsetWidth;let s={x:null,y:null};const a=t=>{var a;t.preventDefault(),((e,t)=>{t.style.left=Math.max(0-r/2,Math.min(e.clientX-n.left,i-r/2))+"px",t.style.top=Math.max(130-o,Math.min(e.clientY-n.top,630-o))+"px"})(t,e.mainPin),a=e.mainPin,s.x=Math.round(a.offsetLeft+r/2),s.y=Math.round(a.offsetTop+o),e.addressInput.value=`${s.x}, ${s.y}`},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u)};return{onMainPinClick:t=>{t.preventDefault(),0===t.button&&(n.left=t.clientX-e.mainPin.offsetLeft,n.top=t.clientY-e.mainPin.offsetTop,document.addEventListener("mousemove",a),document.addEventListener("mouseup",u))}}}},(()=>{const e=document.querySelector("#capacity"),t=document.querySelector("#room_number"),n=document.querySelector(".map__filters-container"),r=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card"),i=document.querySelector("#success").content.querySelector(".success"),s=document.querySelector("#error").content.querySelector(".error"),a=document.querySelector(".ad-form__reset"),u=document.querySelector(".ad-form__submit"),d=document.querySelector("#pin").content.querySelector(".map__pin"),c=document.querySelector(".map__pins"),l=document.querySelector("#housing-type"),p=document.querySelector("#housing-price"),m=document.querySelector("#housing-rooms"),f=document.querySelector("#housing-guests"),v=document.querySelector("#housing-features").querySelectorAll("input"),g=document.querySelector(".map__pin--main"),y=document.querySelector(".ad-form"),h=y.querySelectorAll("fieldset"),w=document.querySelector(".map__filters"),L=w.querySelectorAll("select, input"),b=document.querySelector("#address"),E=document.querySelector("#title"),k=document.querySelector("#type"),I=document.querySelector("#price"),_=document.querySelector("#timein"),P=document.querySelector("#timeout"),q=document.querySelector("#avatar"),S=document.querySelector("#images"),C=document.querySelector(".ad-form-header__preview img"),A=document.querySelector(".ad-form__photo"),x={mainPin:g,map:r,form:y,formFieldsets:h,filtersFieldsets:L,addressInput:b,pinTemplate:d,pinsList:c,cardTemplate:o,mapFilters:n,guestsInput:e,roomsInput:t,titleInput:E,housingTypeInput:k,priceInput:I,checkInInput:_,checkOutInput:P,housingTypeFilter:l,priceFilter:p,roomsNumberFilter:m,guestsNumberFilter:f,featuresInputs:v},F=[E,I,e];let M=[];const T=()=>{const e=c.querySelectorAll(".map__pin");for(let t=1;t<e.length;t+=1)e[t].remove()},H={clearPins:T,clearCards:()=>{document.querySelectorAll(".map .map__card").forEach((e=>{e.remove()}));const e=c.querySelectorAll(".map__pin");for(let t=1;t<e.length;t+=1)e[t].classList.remove("map__pin--active")}},{renderPins:$}=window.map.getRenderingHandlers(x,H),V=window.filter.getFilterHandlers(x),N=()=>{T();const e=V(M);$(e)},D=e=>({onPopupEscPress:t=>{"Escape"===t.key&&(e.remove(),document.removeEventListener("keydown",D(e).onPopupEscPress),document.removeEventListener("click",D(e).onPopupClick))},onPopupClick:t=>{0===t.button&&(e.remove(),document.removeEventListener("click",D(e).onPopupClick),document.removeEventListener("keydown",D(e).onPopupEscPress))}}),R=()=>{y.reset(),w.reset(),W.setInactivePageMode();const e=i.cloneNode(!0);document.querySelector("main").appendChild(e),document.addEventListener("keydown",D(e).onPopupEscPress),document.addEventListener("click",D(e).onPopupClick)},O=()=>{const e=s.cloneNode(!0);document.querySelector("main").appendChild(e);const t=document.querySelector(".error__button");document.addEventListener("keydown",D(e).onPopupEscPress),document.addEventListener("click",D(e).onPopupClick),t.addEventListener("click",D(e).onPopupClick)},W=window.activation.getPageActivationHandlers(x,H,"https://21.javascript.pages.academy/keksobooking/data",(e=>{M=e,N(),window.activation.activateFilters(x)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),j={pinWidth:W.pinWidth,pinHeight:W.pinHeightActive},X=window.pinMovement.getPinMovementHandlers(x,j).onMainPinClick;g.addEventListener("mousedown",X);const{checkGuestNumberValidity:G,validateTitle:z,validateHousingType:Y,validatePrice:B,validateCheckIn:U,validateCheckOut:J,validateImage:K}=window.form.getValidityCheckHandlers(x);document.addEventListener("DOMContentLoaded",(()=>{G()})),l.addEventListener("input",(()=>{N()})),w.addEventListener("input",window.debounce(N)),e.addEventListener("input",(()=>{G()})),t.addEventListener("input",(()=>{G()})),k.addEventListener("input",(()=>{Y()})),_.addEventListener("input",(()=>{U()})),P.addEventListener("input",(()=>{J()})),z(),B(),K(q),K(S),window.imagePreview.getImagePreview(q,C);const Q=document.createElement("img");Q.alt="Фотография жилья",Q.style.width="100%",S.addEventListener("change",(()=>{A.appendChild(Q)})),window.imagePreview.getImagePreview(S,Q),W.setInactivePageMode(),y.addEventListener("submit",(e=>{window.upload.uploadForm(new FormData(y),R,O),e.preventDefault()})),u.addEventListener("click",(()=>{F.forEach((e=>{e.style=e.checkValidity()?"":"box-shadow: 0 0 2px 2px red;"}))})),F.forEach((e=>{e.addEventListener("input",(()=>{e.style=e.checkValidity()?"":"box-shadow: 0 0 2px 2px red"}))})),a.addEventListener("click",(e=>{0===e.button&&(e.preventDefault(),y.reset(),w.reset(),W.setInactivePageMode())})),window.main={pageActivation:W}})()})();